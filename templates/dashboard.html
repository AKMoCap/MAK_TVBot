{% extends "base.html" %}

{% block title %}Dashboard - MAK Trading Bot{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Account Overview Cards -->
    <div class="col-12">
        <div class="row g-3">
            <!-- Account Value -->
            <div class="col-md-3">
                <div class="card bg-darker border-secondary h-100">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1 small">Total Account Value</h6>
                                <h4 class="mb-0" id="account-value">$0.00</h4>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div class="stablecoin-breakdown text-end" style="font-size: 0.6rem; line-height: 1.15;">
                                    <div class="text-muted">USDC (P): <span id="usdc-perps">$0.00</span></div>
                                    <div class="text-muted">USDC (P-Avail): <span id="usdc-perps-avail">$0.00</span></div>
                                    <div class="text-muted">USDC (Spot): <span id="usdc-spot">$0.00</span></div>
                                    <div class="text-muted">USDH: <span id="usdh-balance">$0.00</span></div>
                                </div>
                                <div class="bg-primary bg-opacity-25 p-2 rounded transfer-btn" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#transferModal" title="Transfer USDC between Spot and Perps">
                                    <i class="bi bi-arrow-left-right text-primary fs-5"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collateral at Risk -->
            <div class="col-md-3">
                <div class="card bg-darker border-secondary h-100">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1 small">Collateral at Risk</h6>
                                <h4 class="mb-0" id="collateral-at-risk">$0.00</h4>
                            </div>
                            <div class="bg-info bg-opacity-25 p-2 rounded">
                                <i class="bi bi-shield-exclamation text-info fs-5"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cross Margin Ratio & Acct Leverage -->
            <div class="col-md-3">
                <div class="card bg-darker border-secondary h-100">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex gap-3">
                                <div>
                                    <h6 class="text-muted mb-1 small">Margin Ratio</h6>
                                    <h4 class="mb-0" id="effective-leverage">0.0x</h4>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1 small">Acct. Leverage</h6>
                                    <h4 class="mb-0" id="account-leverage">0.0x</h4>
                                </div>
                            </div>
                            <div class="bg-warning bg-opacity-25 p-2 rounded">
                                <i class="bi bi-speedometer2 text-warning fs-5"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current P&L -->
            <div class="col-md-3">
                <div class="card bg-darker border-secondary h-100">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1 small">Current P&L</h6>
                                <h4 class="mb-0" id="current-pnl">$0.00</h4>
                            </div>
                            <div class="bg-success bg-opacity-25 p-2 rounded" id="current-pnl-icon-container">
                                <i class="bi bi-graph-up text-success fs-5" id="current-pnl-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="col-lg-8">
        <!-- TradingView Chart -->
        <div class="card bg-darker border-secondary" id="tradingview-card">
            <!-- TradingView Widget BEGIN -->
            <div class="tradingview-widget-container" style="height:100%;width:100%">
                <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/symbols/BTCUSDT/?exchange=BINANCE" rel="noopener nofollow" target="_blank"><span class="blue-text">BTCUSDT price</span></a><span class="trademark"> by TradingView</span></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                {
                    "allow_symbol_change": true,
                    "calendar": false,
                    "details": false,
                    "hide_side_toolbar": true,
                    "hide_top_toolbar": false,
                    "hide_legend": false,
                    "hide_volume": false,
                    "hotlist": false,
                    "interval": "240",
                    "locale": "en",
                    "save_image": false,
                    "style": "1",
                    "symbol": "BINANCE:BTCUSDT",
                    "theme": "dark",
                    "timezone": "America/New_York",
                    "backgroundColor": "#0d1117",
                    "gridColor": "rgba(242, 242, 242, 0.06)",
                    "watchlist": [
                        "BINANCE:BTCUSDT",
                        "BINANCE:ETHUSDT",
                        "BINANCE:SOLUSDT",
                        "PYTH:HYPEUSD",
                        "BINANCE:AAVEUSDT",
                        "BINANCE:ENAUSDT",
                        "CRYPTOCAP:PENDLE",
                        "COINBASE:AEROUSD",
                        "BINANCE:VIRTUALUSDT",
                        "CRYPTOCAP:DOGE",
                        "BINANCE:BONKUSDT",
                        "BINANCE:PEPEUSDT",
                        "CRYPTO:FARTCOINUSD"
                    ],
                    "withdateranges": false,
                    "range": "YTD",
                    "compareSymbols": [],
                    "studies": [
                        "STD;RSI"
                    ],
                    "autosize": true
                }
                </script>
            </div>
            <!-- TradingView Widget END -->
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Trade Panel -->
        <div class="card bg-darker border-secondary" id="quick-trade-card">
            <div class="card-header bg-transparent border-secondary">
                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Trade</h5>
            </div>
            <div class="card-body">
                <form id="quick-trade-form">
                    <div class="mb-3">
                        <label class="form-label">Coin / Category</label>
                        <select class="form-select bg-dark text-light border-secondary" id="trade-coin">
                            <optgroup label="MAJORS">
                                <option value="BTC">BTC</option>
                                <option value="ETH">ETH</option>
                                <option value="SOL">SOL</option>
                                <option value="HYPE">HYPE</option>
                            </optgroup>
                            <optgroup label="DEFI">
                                <option value="AAVE">AAVE</option>
                                <option value="ENA">ENA</option>
                                <option value="PENDLE">PENDLE</option>
                                <option value="AERO">AERO</option>
                            </optgroup>
                            <optgroup label="HIGH BETA / MEMES">
                                <option value="DOGE">DOGE</option>
                                <option value="PUMP">PUMP</option>
                                <option value="FARTCOIN">FARTCOIN</option>
                                <option value="kBONK">kBONK</option>
                                <option value="kPEPE">kPEPE</option>
                                <option value="PENGU">PENGU</option>
                                <option value="VIRTUAL">VIRTUAL</option>
                            </optgroup>
                            <optgroup label="â”€â”€ TRADE ALL IN CATEGORY â”€â”€">
                                <option value="CAT:MAJORS">ðŸ“Š All MAJORS (4 coins)</option>
                                <option value="CAT:DEFI">ðŸ“Š All DEFI (4 coins)</option>
                                <option value="CAT:MEMES">ðŸ“Š All HIGH BETA/MEMES (7 coins)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Collateral (USD)</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="trade-collateral" value="100" min="1" step="1">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Leverage</label>
                            <div class="input-group">
                                <input type="range" class="form-range" id="trade-leverage-range"
                                       min="1" max="20" value="3" style="flex: 1;">
                                <span class="ms-2 badge bg-primary" id="leverage-display">3x</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Stop Loss %</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary"
                               id="trade-sl" value="15" step="0.1">
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">TP1 Target %</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="trade-tp1" value="50" step="0.1">
                        </div>
                        <div class="col-6">
                            <label class="form-label">TP1 Size %</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="trade-tp1-size" value="25" step="1">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">TP2 Target %</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="trade-tp2" value="100" step="0.1">
                        </div>
                        <div class="col-6">
                            <label class="form-label">TP2 Size %</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="trade-tp2-size" value="50" step="1">
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" id="buy-btn">
                            <i class="bi bi-arrow-up-circle me-1"></i>Long / Buy
                        </button>
                        <button type="button" class="btn btn-danger" id="sell-btn">
                            <i class="bi bi-arrow-down-circle me-1"></i>Short / Sell
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Positions/Spot/Orders Table - Full Width -->
    <div class="col-12">
        <div class="card bg-darker border-secondary">
            <div class="card-header bg-transparent border-secondary d-flex justify-content-between align-items-center">
                <div class="positions-tabs">
                    <span class="positions-tab active" data-tab="perps">Perps</span>
                    <span class="positions-tab" data-tab="spot">Spot</span>
                    <span class="positions-tab" data-tab="orders">Open Orders</span>
                </div>
                <div id="perps-controls">
                    <select id="side-filter" class="form-select form-select-sm d-inline-block me-2" style="width: auto; background-color: var(--bg-darker); color: var(--text-light); border-color: var(--border-color);">
                        <option value="">All Sides</option>
                        <option value="long">Long Only</option>
                        <option value="short">Short Only</option>
                    </select>
                    <button class="btn btn-outline-danger btn-sm" id="close-all-btn">
                        <i class="bi bi-x-circle me-1"></i>Close All
                    </button>
                </div>
            </div>

            <!-- Perps Tab Content -->
            <div class="card-body p-0 tab-content" id="tab-perps">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 table-sm positions-table-compact" id="perps-table-sortable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="coin" data-type="text">Coin <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th class="sortable" data-sort="side" data-type="text">Side <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th class="sortable" data-sort="leverage" data-type="number">Lev <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th class="sortable" data-sort="margin" data-type="number">Posted <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th class="sortable active desc" data-sort="posValue" data-type="number">Pos. Value <i class="bi bi-arrow-down sort-icon"></i></th>
                                <th class="sortable" data-sort="size" data-type="number">Size <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th class="sortable" data-sort="entry" data-type="number">Entry <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th class="sortable" data-sort="mark" data-type="number">Mark <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th class="sortable" data-sort="liq" data-type="number">Liq. <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th class="sortable" data-sort="funding" data-type="number">Funding <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th class="sortable" data-sort="pnl" data-type="number">P&L <i class="bi bi-arrow-down-up sort-icon"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="positions-table">
                            <tr>
                                <td colspan="12" class="text-center text-muted py-3">
                                    <i class="bi bi-inbox fs-4 d-block mb-1"></i>
                                    No open positions
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Spot Tab Content -->
            <div class="card-body p-0 tab-content" id="tab-spot" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 table-sm spot-table-compact">
                        <thead>
                            <tr>
                                <th>Coin</th>
                                <th>Units</th>
                                <th>$ Value</th>
                            </tr>
                        </thead>
                        <tbody id="spot-table">
                            <tr>
                                <td colspan="3" class="text-center text-muted py-3">
                                    <i class="bi bi-inbox fs-4 d-block mb-1"></i>
                                    No spot balances
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Open Orders Tab Content -->
            <div class="card-body p-0 tab-content" id="tab-orders" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 table-sm positions-table-compact">
                        <thead>
                            <tr>
                                <th>Coin</th>
                                <th>Direction</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th>Price</th>
                                <th>Order Value</th>
                                <th>Filled</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-3">
                                    <i class="bi bi-inbox fs-4 d-block mb-1"></i>
                                    No open orders
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Close Position Modal -->
<div class="modal fade" id="closePositionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Close Position</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to close the <strong id="close-position-coin"></strong> position?</p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-close-btn">Close Position</button>
            </div>
        </div>
    </div>
</div>

<!-- Transfer USDC Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-arrow-left-right me-2"></i>Transfer USDC</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Direction</label>
                    <select class="form-select bg-darker text-light border-secondary" id="transfer-direction">
                        <option value="spotToPerp">Spot â†’ Perps</option>
                        <option value="perpToSpot">Perps â†’ Spot</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Amount (USDC)</label>
                    <div class="input-group">
                        <input type="number" class="form-control bg-darker text-light border-secondary" id="transfer-amount" placeholder="0.00" step="0.01" min="0">
                        <button class="btn btn-outline-secondary" type="button" id="transfer-max-btn">MAX</button>
                    </div>
                    <div class="form-text text-muted mt-1">
                        Available: <span id="transfer-available">$0.00</span>
                    </div>
                </div>
                <div class="alert alert-info py-2" style="font-size: 0.85rem;">
                    <i class="bi bi-info-circle me-1"></i>
                    Transfer between your Spot and Perps accounts on Hyperliquid.
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-transfer-btn">
                    <i class="bi bi-arrow-left-right me-1"></i>Transfer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize dashboard
    initDashboard();

    // Refresh data every 5 seconds
    setInterval(refreshDashboard, 5000);

    // Sync TradingView chart height with Quick Trade panel
    function syncChartHeight() {
        const quickTradeCard = document.getElementById('quick-trade-card');
        const tradingviewCard = document.getElementById('tradingview-card');
        if (quickTradeCard && tradingviewCard) {
            tradingviewCard.style.height = quickTradeCard.offsetHeight + 'px';
        }
    }

    // Sync on load and resize
    syncChartHeight();
    window.addEventListener('resize', syncChartHeight);
    // Also sync after a short delay to ensure Quick Trade panel is fully rendered
    setTimeout(syncChartHeight, 100);
});
</script>
{% endblock %}
