{% extends "base.html" %}

{% block title %}Settings - MAK Trading Bot{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- General Settings -->
    <div class="col-md-6">
        <div class="card bg-darker border-secondary">
            <div class="card-header bg-transparent border-secondary">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>General Settings</h5>
            </div>
            <div class="card-body">
                <form id="general-settings-form">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="bot-enabled" checked>
                            <label class="form-check-label" for="bot-enabled">Bot Enabled</label>
                        </div>
                        <small class="text-muted">When disabled, webhooks will be received but trades won't execute</small>
                    </div>

                    <hr class="border-secondary">

                    <div class="mb-3">
                        <label class="form-label">Default Leverage</label>
                        <div class="input-group">
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="default-leverage" value="3" min="1" max="10">
                            <span class="input-group-text bg-dark text-light border-secondary">x</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Default Collateral (USD)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light border-secondary">$</span>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="default-collateral" value="100" min="1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Slippage Tolerance</label>
                        <div class="input-group">
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="slippage-tolerance" value="0.3" min="0.1" max="5" step="0.1">
                            <span class="input-group-text bg-dark text-light border-secondary">%</span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Save Settings
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Risk Management -->
    <div class="col-md-6">
        <div class="card bg-darker border-secondary">
            <div class="card-header bg-transparent border-secondary">
                <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>Risk Management</h5>
            </div>
            <div class="card-body">
                <form id="risk-settings-form">
                    <h6 class="text-muted mb-3">Position Limits</h6>

                    <div class="mb-3">
                        <label class="form-label">Max Position Value</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light border-secondary">$</span>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="max-position-value" value="1000" min="100">
                        </div>
                        <small class="text-muted">Maximum collateral per position</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Max Total Exposure</label>
                        <div class="input-group">
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="max-exposure-pct" value="75" min="1" max="100" step="1">
                            <span class="input-group-text bg-dark text-light border-secondary">%</span>
                        </div>
                        <small class="text-muted">Maximum % of account USDC collateral at risk</small>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Save Risk Settings
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Coin Configuration -->
    <div class="col-12">
        <div class="card bg-darker border-secondary">
            <div class="card-header bg-transparent border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-currency-exchange me-2"></i>Coin Configuration</h5>
                <div>
                    <button class="btn btn-outline-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addNewPerpModal">
                        <i class="bi bi-plus-circle me-1"></i>Add New Perp
                    </button>
                    <button class="btn btn-outline-warning btn-sm me-2" id="refresh-leverage-btn" onclick="refreshLeverageTables()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh Leverage Tables
                    </button>
                    <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#setDefaultsAllModal">
                        <i class="bi bi-gear me-1"></i>Set Defaults for All
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 table-sm coin-config-compact" id="coin-config-table-container">
                        <thead>
                            <tr>
                                <th>Coin</th>
                                <th>Enabled</th>
                                <th>Lev Offered</th>
                                <th>Margin</th>
                                <th>Default Lev</th>
                                <th>Collateral</th>
                                <th>Max Size</th>
                                <th>SL %</th>
                                <th>TP1</th>
                                <th>TP2</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="coin-config-table">
                            <tr>
                                <td colspan="11" class="text-center text-muted py-2">
                                    Loading coin configurations...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet & Connection -->
    <div class="col-md-6">
        <div class="card bg-darker border-secondary">
            <div class="card-header bg-transparent border-secondary">
                <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>Wallet & Connection</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Connect your wallet using the button in the navigation bar. Your agent wallet allows trading without exposing your main wallet keys.
                </div>

                <div class="mb-3">
                    <label class="form-label">Connected Wallet</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary"
                           id="main-wallet" readonly placeholder="Not connected">
                </div>

                <div class="mb-3">
                    <label class="form-label">Agent Wallet Status</label>
                    <div id="api-wallet-status">
                        <span class="badge bg-secondary"><i class="bi bi-clock me-1"></i>Checking...</span>
                    </div>
                    <small class="text-muted">Agent wallet allows secure trading without exposing your keys</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">HIP-3 DEX Abstraction</label>
                    <div id="hip3-status">
                        <span class="badge bg-secondary"><i class="bi bi-clock me-1"></i>Checking...</span>
                    </div>
                    <small class="text-muted">Required for trading builder-deployed perpetuals</small>
                </div>

                <button class="btn btn-outline-info" id="test-connection">
                    <i class="bi bi-wifi me-1"></i>Test Connection
                </button>
            </div>
        </div>
    </div>

    <!-- Database & Logs -->
    <div class="col-md-6">
        <div class="card bg-darker border-secondary">
            <div class="card-header bg-transparent border-secondary">
                <h5 class="mb-0"><i class="bi bi-database me-2"></i>Data Management</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6>Database</h6>
                    <p class="text-muted mb-2">Trade history and configuration are stored locally.</p>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" id="export-data">
                            <i class="bi bi-download me-1"></i>Export Data
                        </button>
                        <button class="btn btn-outline-danger" id="clear-trades">
                            <i class="bi bi-trash me-1"></i>Clear Trade History
                        </button>
                    </div>
                </div>

                <hr class="border-secondary">

                <div>
                    <h6>Activity Logs</h6>
                    <p class="text-muted mb-2">View recent bot activity and errors.</p>
                    <div class="btn-group">
                        <a href="/api/logs" class="btn btn-outline-secondary" target="_blank">
                            <i class="bi bi-file-text me-1"></i>View Logs
                        </a>
                        <button class="btn btn-outline-danger" id="clear-logs">
                            <i class="bi bi-trash me-1"></i>Clear Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Coin Modal -->
<div class="modal fade" id="editCoinModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Edit Coin Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-coin-form">
                    <input type="hidden" id="edit-coin-name">

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="edit-coin-enabled" checked>
                            <label class="form-check-label" for="edit-coin-enabled">Trading Enabled</label>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">Default Leverage</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="edit-coin-leverage" min="1" max="10">
                                <span class="input-group-text bg-dark text-light border-secondary">x</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label class="form-label">Default Collateral</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark text-light border-secondary">$</span>
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="edit-coin-collateral" min="1">
                            </div>
                        </div>
                        <div class="col-4">
                            <label class="form-label">Max Position Size</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark text-light border-secondary">$</span>
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="edit-coin-max-size" min="100">
                            </div>
                        </div>
                    </div>

                    <hr class="border-secondary">
                    <h6 class="text-muted mb-3">Stop Loss</h6>

                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">Stop Loss %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="edit-coin-sl" min="1" max="50" step="0.5" value="15">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                        </div>
                    </div>

                    <hr class="border-secondary">
                    <h6 class="text-muted mb-3">Take Profit Levels</h6>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">TP1 Target %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="edit-coin-tp1" min="1" max="500" step="1" value="50">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                            <small class="text-muted">Target gain to trigger TP1</small>
                        </div>
                        <div class="col-6">
                            <label class="form-label">TP1 Size %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="edit-coin-tp1-size" min="1" max="100" step="1" value="25">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                            <small class="text-muted">% of position to close at TP1</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">TP2 Target %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="edit-coin-tp2" min="1" max="500" step="1" value="100">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                            <small class="text-muted">Target gain to trigger TP2</small>
                        </div>
                        <div class="col-6">
                            <label class="form-label">TP2 Size %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="edit-coin-tp2-size" min="1" max="100" step="1" value="50">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                            <small class="text-muted">% of position to close at TP2</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-coin-config">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add New Perp Modal -->
<div class="modal fade" id="addNewPerpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add New Perpetual</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-new-perp-form">
                    <div class="mb-3">
                        <label class="form-label">Ticker</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary"
                               id="new-perp-ticker" placeholder="e.g., BTC, ETH, SOL" required>
                        <small class="text-muted">Enter the coin ticker symbol</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="new-perp-hip3">
                            <label class="form-check-label" for="new-perp-hip3">
                                HIP-3 Perpetual
                            </label>
                        </div>
                        <small class="text-muted">Check if this is a HIP-3 deployed perpetual</small>
                    </div>

                    <div class="mb-3" id="hip3-dex-container" style="display: none;">
                        <label class="form-label">HIP-3 DEX Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary"
                               id="new-perp-dex" placeholder="e.g., hypurrfun">
                        <small class="text-muted">The DEX name (format: {dex}:{coin})</small>
                    </div>
                </form>
                <div id="add-perp-result" class="mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="add-perp-btn" onclick="addNewPerp()">
                    <i class="bi bi-plus-circle me-1"></i>Add Perp
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Set Defaults for All Modal -->
<div class="modal fade" id="setDefaultsAllModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Set Defaults for All Coins</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2" style="font-size: 0.85rem;">
                    <i class="bi bi-info-circle me-1"></i>
                    These values will be applied to ALL coins. Individual coin settings can still be modified afterward.
                </div>
                <form id="set-defaults-all-form">
                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">Default Leverage</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="all-coin-leverage" min="1" max="20" value="3">
                                <span class="input-group-text bg-dark text-light border-secondary">x</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label class="form-label">Default Collateral</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark text-light border-secondary">$</span>
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="all-coin-collateral" min="1" value="100">
                            </div>
                        </div>
                        <div class="col-4">
                            <label class="form-label">Max Position Size</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark text-light border-secondary">$</span>
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="all-coin-max-size" min="100" value="1000">
                            </div>
                        </div>
                    </div>

                    <hr class="border-secondary">
                    <h6 class="text-muted mb-3">Stop Loss</h6>

                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">Stop Loss %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="all-coin-sl" min="1" max="50" step="0.5" value="15">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                        </div>
                    </div>

                    <hr class="border-secondary">
                    <h6 class="text-muted mb-3">Take Profit Levels</h6>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">TP1 Target %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="all-coin-tp1" min="1" max="500" step="1" value="50">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                            <small class="text-muted">Target gain to trigger TP1</small>
                        </div>
                        <div class="col-6">
                            <label class="form-label">TP1 Size %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="all-coin-tp1-size" min="1" max="100" step="1" value="25">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                            <small class="text-muted">% of position to close at TP1</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">TP2 Target %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="all-coin-tp2" min="1" max="500" step="1" value="100">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                            <small class="text-muted">Target gain to trigger TP2</small>
                        </div>
                        <div class="col-6">
                            <label class="form-label">TP2 Size %</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                       id="all-coin-tp2-size" min="1" max="100" step="1" value="50">
                                <span class="input-group-text bg-dark text-light border-secondary">%</span>
                            </div>
                            <small class="text-muted">% of position to close at TP2</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-all-coin-defaults">
                    <i class="bi bi-check-circle me-1"></i>Apply to All Coins
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    loadCoinConfigs();
    setupSettingsEvents();

    document.getElementById('general-settings-form').addEventListener('submit', saveGeneralSettings);
    document.getElementById('risk-settings-form').addEventListener('submit', saveRiskSettings);
    document.getElementById('test-connection').addEventListener('click', testConnection);
    document.getElementById('save-coin-config').addEventListener('click', saveCoinConfig);
    document.getElementById('save-all-coin-defaults').addEventListener('click', saveAllCoinDefaults);
});
</script>
{% endblock %}
